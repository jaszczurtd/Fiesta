
#include <Arduino.h>
#include <Adafruit_GFX.h>    // Core graphics library
#include <Adafruit_ST7735.h> // Hardware-specific library for ST7735
#include <Adafruit_ST7789.h> // Hardware-specific library for ST7789

#include "graphics.h"

#define MINIMUM_FUEL_AMOUNT_PERCENTAGE 10

#define FUEL_WIDTH 18
#define FUEL_HEIGHT 18

#define OFFSET 4

static char *half = (char*)"1/2";
static char *full = (char*)"F";
static char *empty = (char*)"E";

const unsigned int fuelIcon[] PROGMEM = {
0x0000, 0x0000, 0x0000, 0xf5a5, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfd80, 0xe5eb, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe60e, 0xedc9, 0xe5ea, 0xe5ea, 0xe5ea, 0xe5ea, 0xe5ea, 0xe5ea, 0xf5a3, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0xe5ec, 0xeda6, 0x0000, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0xedc7, 0xedc9, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0xfda0, 0xe60e, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe60f, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xedc6, 0xe5ea, 0x0000, 0x0000, 0xfd80, 0xfda0, 0xf5a3, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0x0000, 0xe5eb, 0xfda0, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0x0000, 0x0000, 0xeda6, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xf5a4, 0x0000, 0x0000, 0x0000, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe60d, 0xe5ed, 0xedc9, 0x0000, 0x0000, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xf5a3, 0x0000, 0x0000, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xf5a2, 0x0000, 0x0000, 0xfd80, 0xedc9, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xfda0, 0x0000, 0x0000, 0xf5a3, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xfd80, 0x0000, 0xe5ea, 0xedc8, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xe5eb, 0xf5a5, 0xfda2, 0xe5ea, 0x0000, 
0x0000, 0x0000, 0xf5a5, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ec, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 
0x0000, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5eb, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

int getBaseX(void) {
    return OFFSET + FUEL_WIDTH + OFFSET;
}

int getBaseY(void) {
    return SCREEN_H - FUEL_HEIGHT - textHeight(empty) - (OFFSET / 2); 
}

int getWidth(void) {
    return SCREEN_W - getBaseX() - OFFSET;
}

void showFuelAmount(int currentVal, int maxVal) {
    Adafruit_ST7735 tft = returnReference();

    int x = getBaseX(), y = getBaseY(), w, tw, width = getWidth();

    drawImage(OFFSET, y, FUEL_WIDTH, FUEL_HEIGHT, (unsigned int*)fuelIcon);

    double percent = (currentVal * 100) / maxVal;
    w = percentToWidth(percent, width);

    drawChangeableFuelContent(w);

    y += FUEL_HEIGHT + (OFFSET / 2);

    tft.setTextSize(1);
    tft.setTextColor(ST7735_RED);
    tft.setCursor(x, y);
    tft.println(empty);

    tw = textWidth(half);
    x = getBaseX();
    x += ((width - tw) / 2);

    tft.setTextColor(ST7735_WHITE);
    tft.setCursor(x, y);
    tft.println(half);

    x = getBaseX() + width;
    tw = textWidth(full);
    x -= tw;

    tft.setCursor(x, y);
    tft.println(full);
}

static int lastWidth = 0;

void drawChangeableFuelContent(int w) {

    bool draw = false;
    if(lastWidth != w) {
        draw = true;
    }

    int color = C_GRAY_MEDIUM;

    int width = getWidth();
    int minW = percentToWidth(MINIMUM_FUEL_AMOUNT_PERCENTAGE, width);
    if((w > minW) || alertSwitch()) {
        draw = true;
        color = ST7735_RED;
    }

    if(draw) {
        Adafruit_ST7735 tft = returnReference();        

        int x = getBaseX(), y = getBaseY(); 
        tft.fillRect(x, y, w, FUEL_HEIGHT, color);
        tft.drawLine(x + w, y, x + w, y + FUEL_HEIGHT, ST7735_BLACK);
        tft.drawRect(x, y, width, FUEL_HEIGHT, C_GRAY_DARK);
    }
}

