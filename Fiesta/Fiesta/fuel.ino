
#include <Arduino.h>
#include <Adafruit_GFX.h>    // Core graphics library
#include <Adafruit_ST7735.h> // Hardware-specific library for ST7735
#include <Adafruit_ST7789.h> // Hardware-specific library for ST7789

#include "graphics.h"

#define MINIMUM_FUEL_AMOUNT_PERCENTAGE 10

#define FUEL_WIDTH 18
#define FUEL_HEIGHT 18

#define OFFSET 4

static char *half = (char*)"1/2";
static char *full = (char*)"F";
static char *empty = (char*)"E";
static char *emptyMessage = (char*)"Pusty bak!";

static bool drawOnce = true; 
void redrawFuel(void) {
    drawOnce = true;
}

static int currentWidth = 0;

const unsigned int fuelIcon[] PROGMEM = {
0x0000, 0x0000, 0x0000, 0xf5a5, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfd80, 0xe5eb, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe60e, 0xedc9, 0xe5ea, 0xe5ea, 0xe5ea, 0xe5ea, 0xe5ea, 0xe5ea, 0xf5a3, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0xe5ec, 0xeda6, 0x0000, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0xedc7, 0xedc9, 0x0000, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0xfda0, 0xe60e, 0x0000, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xe60f, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xedc6, 0xe5ea, 0x0000, 0x0000, 0xfd80, 0xfda0, 0xf5a3, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0x0000, 0xe5eb, 0xfda0, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0x0000, 0x0000, 0xeda6, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xf5a4, 0x0000, 0x0000, 0x0000, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe60d, 0xe5ed, 0xedc9, 0x0000, 0x0000, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xf5a3, 0x0000, 0x0000, 0xfda0, 0xfda0, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xf5a2, 0x0000, 0x0000, 0xfd80, 0xedc9, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xfda0, 0x0000, 0x0000, 0xf5a3, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xfd80, 0x0000, 0xe5ea, 0xedc8, 0x0000, 
0x0000, 0x0000, 0xe5ea, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ea, 0x0000, 0xe5eb, 0xf5a5, 0xfda2, 0xe5ea, 0x0000, 
0x0000, 0x0000, 0xf5a5, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5ec, 0x0000, 0x0000, 0xe5ea, 0xe5ea, 0x0000, 0x0000, 
0x0000, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xfda0, 0xe5eb, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

int getBaseX(void) {
    return OFFSET + FUEL_WIDTH + OFFSET;
}

int getBaseY(void) {
    return SCREEN_H - FUEL_HEIGHT - textHeight(empty) - (OFFSET / 2); 
}

int getWidth(void) {
    return SCREEN_W - getBaseX() - OFFSET;
}

void drawFuelEmpty(void) {
    if(currentWidth <= 1) {

        int color = ST7735_WHITE;
        if(seriousAlertSwitch()) {
            color = ST7735_RED;
        }

        int x = getBaseX() + ((getWidth() - textWidth(emptyMessage)) / 2);
        int y = getBaseY() + ((FUEL_HEIGHT - textHeight(emptyMessage)) / 2);

        Adafruit_ST7735 tft = returnReference();
        tft.setTextSize(1);
        tft.setTextColor(color);
        tft.setCursor(x, y);
        tft.println(emptyMessage);
    }
}

void showFuelAmount(int currentVal, int maxVal) {
    int width = getWidth();
    double percent = (currentVal * 100) / maxVal;
    currentWidth = percentToWidth(percent, width);

    if(drawOnce) {
        Adafruit_ST7735 tft = returnReference();

        int x = getBaseX(), y = getBaseY(), tw;

        drawImage(OFFSET, y, FUEL_WIDTH, FUEL_HEIGHT, (unsigned int*)fuelIcon);

        drawChangeableFuelContent(currentWidth);

        y += FUEL_HEIGHT + (OFFSET / 2);

        tft.setTextSize(1);
        tft.setTextColor(ST7735_RED);
        tft.setCursor(x, y);
        tft.println(empty);

        tw = textWidth(half);
        x = getBaseX();
        x += ((width - tw) / 2);

        tft.setTextColor(ST7735_WHITE);
        tft.setCursor(x, y);
        tft.println(half);

        x = getBaseX() + width;
        tw = textWidth(full);
        x -= tw;

        tft.setCursor(x, y);
        tft.println(full);

        drawOnce = false;
    } else {
        drawChangeableFuelContent(currentWidth);
    }
}

static int lastWidth = 0;

void drawChangeableFuelContent(int w) {

    bool draw = false;
    if(lastWidth != w) {
        draw = true;
    }

    int color = C_GRAY_MEDIUM;

    int width = getWidth();
    int minW = percentToWidth(MINIMUM_FUEL_AMOUNT_PERCENTAGE, width);
    if((w > minW) || alertSwitch()) {
        draw = true;
        color = ST7735_RED;
    }

    if(draw) {
        Adafruit_ST7735 tft = returnReference();        

        int x = getBaseX(), y = getBaseY(); 
        tft.fillRect(x, y, w, FUEL_HEIGHT, color);
        tft.drawLine(x + w, y, x + w, y + FUEL_HEIGHT, ST7735_BLACK);
        tft.drawRect(x, y, width, FUEL_HEIGHT, C_GRAY_DARK);
    }
}

